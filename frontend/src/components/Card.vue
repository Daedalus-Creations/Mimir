<template>
  <div class="notification" :style="colorStyle" style="width:100%">
    <b-loading :active.sync="isLoading" :is-full-page="false" :can-cancel="true"></b-loading>
    <div class="level is-mobile">
      <div class="level-left">
        <div class="level-item">
          <h1 class="title is-5">
            <b-icon :icon="typeIconName(quote.type)"></b-icon>
          </h1>
        </div>
        <div class="level-item">
          <input
            class="nostyle title is-5"
            :disabled="!editable"
            :spellcheck="editable"
            :class="editable ? 'editable' : ''"
            placeholder="Book Title"
            v-model="quote.title"
          />
        </div>
      </div>
      <div class="level-right">
        <div class="level-item" v-if="editable">
          <b-dropdown aria-role="list" v-model="quote.type">
            <b-button inverted rounded outlined size="is-small" type="is-info" slot="trigger">Type</b-button>
            <b-dropdown-item
              v-for="quoteType in type"
              :key="quoteType"
              :value="quoteType"
              aria-role="listitem"
            >
              <div class="media">
                <div class="media-left">
                  <b-icon :icon="typeIconName(quoteType)"></b-icon>
                </div>
                <div class="media-content">
                  <h3>{{quoteType}}</h3>
                </div>
              </div>
            </b-dropdown-item>
          </b-dropdown>
        </div>
        <div class="level-item" v-if="editable">
          <swatches v-model="quote.color" shapes="circles" show-fallback popover-to="left">
            <b-button slot="trigger" type="is-info" size="is-small" rounded inverted outlined>color</b-button>
          </swatches>
        </div>
        <div class="level-item">
          <div class="level-item">
            <div class="buttons">
              <b-button
                v-if="editable"
                type="is-danger"
                size="is-small"
                @click="confirmDelete"
                rounded
              >
                <b-icon icon="trash"></b-icon>
              </b-button>
              <b-button
                v-if="editable"
                type="is-success"
                size="is-small"
                rounded
                @click="updateQuote"
              >
                <b-icon icon="check"></b-icon>
              </b-button>
              <b-button
                v-if="!editable"
                type="is-info"
                size="is-small"
                outlined
                rounded
                inverted
                @click="editable = true"
              >
                <b-icon icon="edit" pack="far"></b-icon>
              </b-button>

              <b-button
                v-if="!editable"
                type="is-info"
                size="is-small"
                outlined
                rounded
                inverted
                slot="trigger"
                aria-controls="collapsable"
                @click="isOpen = !isOpen"
              >
                <b-icon :icon="isOpen ? 'compress' : 'expand'"></b-icon>
              </b-button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <textarea
        placeholder="Quote"
        class="nostyle autosize subtitle is-6"
        :disabled="!editable"
        :spellcheck="editable"
        :class="editable ? 'editable' : ''"
        v-model="quote.text"
      ></textarea>
    </div>
    <b-collapse :open.sync="isOpen" aria-id="collapsable">
      <div class="level is-mobile">
        <div class="level-left">
          <div class="level-item">
            <h1 class="title is-6">
              <b-icon icon="user"></b-icon>
            </h1>
          </div>
          <div class="level-item">
            <input
              class="nostyle title is-6"
              :disabled="!editable"
              :spellcheck="editable"
              :class="editable ? 'editable' : ''"
              placeholder="Author"
              v-model="quote.author"
            />
          </div>
        </div>
      </div>
    </b-collapse>
  </div><!--
  <v-card :loading="isLoading" :color="quote.color" width="100%" dark>
    <v-card-title :class="'heading '+quote.color+' darken-2'">
        <v-icon left>fas fa-{{typeIconName(quote.type)}}</v-icon>
        {{quote.title}}
        <v-spacer></v-spacer>
        <v-btn color="error" @click="confirmDelete">Delete</v-btn>
    </v-card-title>
    <v-card-text class="px-10">
      {{quote.text}}
    </v-card-text>
    <v-card-actions>
      <v-list-item>
        <v-list-item-avatar small>
          <v-icon small>fas fa-user</v-icon>
        </v-list-item-avatar>
        <v-list-item-content class="subheading">
          {{quote.author}}
        </v-list-item-content>
      </v-list-item>
      <v-text-field prepend-inner-icon="tag" dense rounded filled label="Tags"></v-text-field>
      
        <v-spacer></v-spacer>
        <v-btn icon><v-icon small>fas fa-sticky-note</v-icon></v-btn>
    </v-card-actions>
  </v-card>-->
</template>

<script lang="ts">
import { Component, Prop, Vue } from "vue-property-decorator";
import { readQuotes } from "@/store/main/getters.ts";
import { commitAddNotification, commitSetQuote } from "@/store/main/mutations";
import { IQuote, type, typeIcon } from "@/interfaces";
import {
  dispatchDeleteQuote,
  dispatchLoadQuotes,
  dispatchUpdateQuote
} from "@/store/main/actions";
import Swatches from "vue-swatches";
const tinycolor = require("tinycolor2");

@Component({
  components: {
    Swatches
  }
})
export default class Card extends Vue {
  public isOpen = true;
  public editable = false;
  public isLoading = false;

  @Prop({ required: true }) id!: number;

  get quote() {
    // find quote with specified id number
    return readQuotes(this.$store).find(quote => quote.id === this.id);
  }

  set quote(newquote) {
    if (newquote) {
      commitSetQuote(this.$store, newquote);
    }
  }
  typeIconName(type): string | undefined {
    return typeIcon.get(type); // get icon name based on type enum
  }
  get type() {
    return type; // get type enum/object
  }
  get colorStyle() {
    if (this.quote) {
      const background = tinycolor(this.quote.color); // get background color
      const textColor = background.isLight() ? "#000" : "#fff"; // invert to get text color
      const outline = background.isLight()
        ? tinycolor(this.quote.color)
            .darken()
            .toHexString()
        : tinycolor(this.quote.color)
            .brighten()
            .toHexString(); // lighten or darken background color to get outline/placeholder color

      const accent = textColor;
      return {
        background: background.toHexString(),
        color: textColor,
        "--placeholder-color": outline,
        "--accent-color": accent,
        "--button-color": textColor
      };
    }
  }

  async updateQuote() {
    try {
      this.isLoading = true; // set loading flag
      if (this.quote) {
        await dispatchUpdateQuote(this.$store, this.quote);
      } // send request to server
      else {
        throw "quote undefined";
      }

      commitAddNotification(this.$store, {
        content: "Changes saved",
        color: "success"
      }); // send notification
      await dispatchLoadQuotes(this.$store); // refresh
    } catch (error) {
      commitAddNotification(this.$store, {
        content: "Something went wrong",
        color: "error"
      }); // send notification
    } finally {
      this.isLoading = false; // reset loading flag
      this.editable = false;
    }
  }
  confirmDelete() {
    this.$buefy.dialog.confirm({
      title: "Deleting Quote",
      message:
        "Are you sure you want to <b>delete</b> this quote? This action cannot be undone.",
      confirmText: "Delete Quote",
      type: "is-danger",
      icon: "exclamation-circle",
      hasIcon: true,
      onConfirm: this.deleteQuote
    });
  }
  async deleteQuote() {
    try {
      this.isLoading = true; // set loading flag
      if (this.quote) {
        await dispatchDeleteQuote(this.$store, this.quote.id);
      } // make api call
      else {
        throw "quote undefined";
      }
      commitAddNotification(this.$store, {
        content: "Quote Deleted",
        color: "success"
      }); // send notification
    } catch (error) {
      commitAddNotification(this.$store, {
        content: "Something went wrong",
        color: "error"
      }); // send notification
    } finally {
      this.isLoading = false; // reset loading flag
      await dispatchLoadQuotes(this.$store); // refresh
    }
  }
}
</script>
<style scoped>
:root {
  --placeholder-color: #fff;
  --accent-color: #000;
  --button-color: #fff;
}
/deep/ ::placeholder {
  color: var(--placeholder-color);
}
/*
    /deep/ button{
      border-color: var(--button-color) !important;
      color: var(--button-color) ;
      background: var(--button-color) !important;
    }*/
/deep/ .ti-input {
  border: None;
}
/deep/ .ti-new-tag-input {
  background: transparent;
  color: var(--accent-color);
}
.nostyle {
  width: 100%;
  outline: None;
  border: None;
  overflow: hidden;
  background-color: transparent;
  -webkit-box-shadow: none;
  -moz-box-shadow: none;
  box-shadow: none;
  resize: none;
}
.editable {
  box-shadow: 0 -2px inset var(--placeholder-color); /*#1e1e1f;*/
}
.editable:focus {
  box-shadow: 0 -2px inset var(--accent-color);
}
.editable:focus-within {
  box-shadow: 0 -2px inset var(--accent-color);
}
</style>
